<?php
namespace Admin\Controller;

use Admin\Model\AdminAuthRuleViewModel;
use Common\Controller\BaseController;
use Think\Controller;

/**
 * 文章管理
 * Class ContentController
 * @package Home\Controller
 */
class ShowController extends BaseAdminController
{

	function _initialize()
	{
		parent::_initialize(); // TODO: Change the autogenerated stub
		$this->set_sidebar_module('Show');
		$this->set_sidebar_sub('index');
	}

    public function index()
    {
		$auth = session_auth();
		if($auth == 1){//支部
            $map = array();
            $map['status']=array('gt',-1);
            $type = I('type');
            if ($type > 0) {
                $map['type'] = $type;
                $this->assign('type',$type);
            }

            $page = D('Show')->findPage($map,15,'is_top desc, create_time desc');
            $this->assign('page',$page);
		}

        $this->display();
    }

    public function add($id=0)
    {
    	if ($id > 0) {
    		$show = D('Show')->find($id);
    		$this->assign('detail', $show);
    	}
        $this->display();
    }

    //  ajax提交保存
    public function ajaxAdd($id = 0)
    {
        // $auth = session_auth();
    	// if ($auth == 1){
    		$data['title'] = I('post.title');
			$data['sort'] = I('post.sort') > 0 ? I('post.sort') : 0;
    		$data['type'] = I('post.type') > 0 ? I('post.type') : 1; // 默认1=党员之家
    		$data['img_url'] = I('post.img_url');
			$data['is_top'] = I('post.is_top');
            $data['url'] = I('post.url');

    		$id = I('post.id');
    		if ($id > 0) {
				D('Show')->where(array('id'=>$id))->save($data);
    		}else{
				$data['create_time'] = time();
				D('Show')->add($data);
			}
            ajaxMsg(0, '保存成功');
   //  	}else{
			// ajaxMsg(1, '权限不足');
   //  	}
    }

     // 删除图片
    public function ajaxDec(){
        $id = I('post.id');
        $article = D('Show')->find($id);
        if($article){
            $article["status"] = -1;
            D('Show')->save($article);
            ajaxMsg(0, "已删除");
        }else{
            ajaxMsg(1,'该图片不存在');
        }
    }

     // 置顶图片
    public function ajaxIsTop(){
        $id = I('post.id');
        $article = D('Show')->find($id);
        if($article){
            if ($article["is_top"] == 0) {
                $article["is_top"] = 1;
                D('Show')->save($article);
                ajaxMsg(0, "已置顶");
            }elseif ($article["is_top"] == 1) {
                $article["is_top"] = 0;
                D('Show')->save($article);
                ajaxMsg(0, "已禁止");
            }
        }else{
            ajaxMsg(1,'该图片不存在');
        }
    }

}