<?php
namespace Admin\Controller;

use Admin\Model\SignInLogViewModel;
use Common\Controller\BaseController;
use Think\Controller;

/**
 * 系统设置
 * Class SystemController
 * @package Admin\Controller
 */
class SignInPrizeController extends BaseAdminController
{
    function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
        $this->set_sidebar_module('App');
        $this->set_sidebar_sub('SignInPrize');
    }

    public function index()
    {
        $auth = session_auth();
        if ($auth == 1) {
            $page = D('SignInLogView')->findPage('', 15, 'SignInLog.create_time desc');
            $this->assign('page', $page);

            $time = strtotime(date('Y-m-d'));
            $count = D('SignInLog')->where(array('create_time'=>array('gt',$time)))->count();
            $this->assign('count',$count);
        }

        $this->display();
    }

    // 抽奖转盘方格列表页
    public function signInPrizeConfigList()
    {
        $auth = session_auth();
        if ($auth == 1) {
            $page = D('SignInPrizeConfig')->findPage('', 15, 'code asc');
            $this->assign('page', $page);
        }

        $this->display('signInPrizeConfigList');
    }

    // 抽奖转盘方格编辑页
    public function signInPrizeConfigAdd()
    {
        $auth = session_auth();
        if ($auth == 1) {
            $id = I('get.id');
            if ($id) {//如果是编辑
                $detail = D('SignInPrizeConfig')->find($id);
                $this->assign('detail', $detail);
            }
        }

        $this->display();
    }


    public function ajaxSavePrizeConfig()
    {
        $id = I('id');
        $point = I('point');
        $probability = I('probability');
        //查找是否有存在的规则
        $saveData = array(
            'point' => $point,
            'probability' => $probability
        );

        $auth = session_auth();
        if ($auth == 1) {
            //如果是保存
            if ($id) {
                D('SignInPrizeConfig')->where(array('id' => $id))->save($saveData);
            } else {
                ajaxMsg(1, '该方格不存在，配置失败');
            }
        }
        ajaxMsg(0, '保存成功');
    }

}